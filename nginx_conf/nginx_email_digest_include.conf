# AI邮件简报系统 - Include配置文件
# 此文件将被主nginx.conf通过include指令引入

# 上游服务器定义 - AI邮件简报系统后端
upstream email_digest_backend {
    least_conn;
    server 127.0.0.1:6006 max_fails=2 fail_timeout=10s weight=1;
    keepalive 16;
}

# AI邮件简报系统服务器配置
server {
    listen       80;
    server_name  email.wyg.life;  # 使用独立域名
    
    # 访问日志（使用您现有的日志格式）
    access_log d:/nginx/logs/email_digest.access.log main;
    error_log  d:/nginx/logs/email_digest.error.log;
    
    # 设置字符集
    charset utf-8;
    
    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 静态文件处理
    location /static/ {
        alias D:/python_projects/fecth_email_with_ai/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # 使用您现有的静态文件优化配置
        tcp_nodelay off;
        open_file_cache max=3000 inactive=120s;
        open_file_cache_valid 45s;
        open_file_cache_min_uses 2;
        open_file_cache_errors off;
    }

    # favicon处理
    location = /favicon.ico {
        alias D:/python_projects/fecth_email_with_ai/static/favicon.ico;
        access_log off;
        log_not_found off;
        expires max;
    }

    # AI助手API路由 - 需要更长的超时时间
    location /api/ai-assistant/ {
        proxy_pass http://email_digest_backend;
        
        # 完整的IP头部配置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        # 阿里云CDN专用头部
        proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
        proxy_set_header X-Via $http_x_via;
        proxy_set_header X-Forwarded-Port $server_port;
        # 通用CDN头部
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header True-Client-IP $http_true_client_ip;
        proxy_set_header X-Originating-IP $http_x_originating_ip;
        proxy_set_header X-Client-IP $http_x_client_ip;
        proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
        proxy_set_header Forwarded-For $http_forwarded_for;
        proxy_set_header Forwarded $http_forwarded;
        
        # 禁用缓存
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # AI处理需要更长时间 - 延长到3分钟
        proxy_connect_timeout 60s;
        proxy_send_timeout 180s;
        proxy_read_timeout 180s;
        
        # 支持大文件
        client_max_body_size 50M;
        client_body_timeout 300s;
    }
    
    # 其他API路由 - 使用您现有的完整IP头部配置风格
    location /api/ {
        proxy_pass http://email_digest_backend;
        
        # 完整的IP头部配置 - 与您现有配置保持一致
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        # 阿里云CDN专用头部
        proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
        proxy_set_header X-Via $http_x_via;
        proxy_set_header X-Forwarded-Port $server_port;
        # 通用CDN头部（保持兼容性）
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header True-Client-IP $http_true_client_ip;
        proxy_set_header X-Originating-IP $http_x_originating_ip;
        proxy_set_header X-Client-IP $http_x_client_ip;
        proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
        proxy_set_header Forwarded-For $http_forwarded_for;
        proxy_set_header Forwarded $http_forwarded;
        
        # 禁用缓存
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # 支持大文件
        client_max_body_size 50M;
        client_body_timeout 300s;
    }
    
    # 邮件处理相关路由 - 延长超时时间
    location ~ ^/(trigger|add_account) {
        proxy_pass http://email_digest_backend;
        
        # 完整的IP头部配置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        # 阿里云CDN专用头部
        proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
        proxy_set_header X-Via $http_x_via;
        proxy_set_header X-Forwarded-Port $server_port;
        # 通用CDN头部
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header True-Client-IP $http_true_client_ip;
        proxy_set_header X-Originating-IP $http_x_originating_ip;
        proxy_set_header X-Client-IP $http_x_client_ip;
        proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
        proxy_set_header Forwarded-For $http_forwarded_for;
        proxy_set_header Forwarded $http_forwarded;
        
        # 延长超时（AI处理需要时间）
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # 禁用缓存
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # 限制请求方法
        limit_except GET POST { deny all; }
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://email_digest_backend;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 健康检查不缓存
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        
        # 快速超时
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # 所有其他请求代理到后端应用
    location / {
        proxy_pass http://email_digest_backend;
        
        # 完整的IP头部配置 - 与您现有配置保持一致
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        # 阿里云CDN专用头部
        proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
        proxy_set_header X-Via $http_x_via;
        proxy_set_header X-Forwarded-Port $server_port;
        # 通用CDN头部
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header True-Client-IP $http_true_client_ip;
        proxy_set_header X-Originating-IP $http_x_originating_ip;
        proxy_set_header X-Client-IP $http_x_client_ip;
        proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
        proxy_set_header Forwarded-For $http_forwarded_for;
        proxy_set_header Forwarded $http_forwarded;
        
        # 页面可以适度缓存（使用您现有的缓存策略）
        proxy_cache_valid 200 302 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        add_header X-Cache-Status $upstream_cache_status;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 120s;
        
        # 缓冲区设置
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 8 32k;
        proxy_busy_buffers_size 64k;
        
        # 支持大文件上传
        client_max_body_size 50M;
        client_body_timeout 300s;
    }

    # 错误页面处理
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        internal;
        root D:/python_projects/fecth_email_with_ai/static;
    }
    
    location = /50x.html {
        internal;
        root D:/python_projects/fecth_email_with_ai/static;
    }
}
