# 🧪 测试综合检索功能

## 🎯 测试目标

验证AI助手是否支持**多条件组合查询**，以及**完整的12种邮件分类**。

---

## 🔄 准备工作

### 1. 重启应用
```batch
# 停止应用
Ctrl+C

# 重新启动
python run_app.py
```

### 2. 打开AI助手
- 访问 http://localhost:5000 或你的域名
- 点击右下角的AI助手按钮

---

## 📋 测试用例

### 一、12种分类测试

测试所有分类是否都能正确识别：

**1. 工作邮件**
```
输入: 工作邮件
预期: 找到work分类的邮件
日志: 分类过滤: 工作 -> work
```

**2. 教育邮件** ⭐ 新增
```
输入: 教育邮件
预期: 找到education分类的邮件
日志: 分类过滤: 教育 -> education
```

**3. 旅行邮件** ⭐ 新增
```
输入: 旅行邮件
预期: 找到travel分类的邮件
日志: 分类过滤: 旅行 -> travel
```

**4. 健康邮件** ⭐ 新增
```
输入: 健康邮件
预期: 找到health分类的邮件
日志: 分类过滤: 健康 -> health
```

**5. 系统邮件** ⭐ 新增
```
输入: 系统邮件
预期: 找到system分类的邮件
日志: 分类过滤: 系统 -> system
```

**6. 广告邮件** ⭐ 新增
```
输入: 广告邮件
预期: 找到advertising分类的邮件
日志: 分类过滤: 广告 -> advertising
```

---

### 二、综合检索测试（重点）

测试多条件组合查询：

#### 测试1: 时间 + 发件人 ⭐ 关键测试
```
输入: 昨天小明发给我的邮件
或: 昨天张三发的邮件

预期AI调用:
{
  "time_range": "yesterday",
  "sender": "小明" (或 "张三")
}

预期日志:
时间过滤: yesterday -> ...
发件人过滤: 小明 (或 张三)

预期结果:
✅ 只返回昨天该发件人的邮件
✅ AI回复包含时间和发件人信息
```

#### 测试2: 时间 + 分类
```
输入: 近三天的工作邮件
或: 本周的教育邮件

预期AI调用:
{
  "time_range": "recent_3_days",
  "category": "工作"
}

预期日志:
时间过滤: recent_3_days -> ...
分类过滤: 工作 -> work

预期结果:
✅ 只返回近三天的工作邮件
✅ AI回复包含时间和分类信息
```

#### 测试3: 分类 + 重要性
```
输入: 重要的工作邮件
或: 重要的财务邮件

预期AI调用:
{
  "category": "工作",
  "importance": 3
}

预期日志:
分类过滤: 工作 -> work
重要性过滤: >= 3

预期结果:
✅ 只返回重要的工作邮件
✅ AI回复包含分类和重要性信息
```

#### 测试4: 三条件组合 ⭐ 高级测试
```
输入: 本周重要的工作邮件
或: 近三天重要的教育邮件

预期AI调用:
{
  "time_range": "this_week",
  "category": "工作",
  "importance": 3
}

预期日志:
时间过滤: this_week -> ...
分类过滤: 工作 -> work
重要性过滤: >= 3

预期结果:
✅ 三个条件都满足的邮件
✅ AI回复准确描述查询条件
```

#### 测试5: 四条件组合 ⭐ 终极测试
```
输入: 昨天张三发的重要工作邮件

预期AI调用:
{
  "time_range": "yesterday",
  "sender": "张三",
  "category": "工作",
  "importance": 3
}

预期日志:
时间过滤: yesterday -> ...
发件人过滤: 张三
分类过滤: 工作 -> work
重要性过滤: >= 3

预期结果:
✅ 四个条件都满足的邮件
✅ 如果没有完全匹配的，返回0封
✅ AI回复清晰说明查询条件
```

---

### 三、新增分类统计测试

测试统计功能是否包含新增分类：

```
输入: 本周统计
或: 近三天统计

预期结果:
📊 本周共收到XX封邮件

分类统计可能包括：
- 工作: XX封
- 教育: XX封    ← ⭐ 新增分类
- 旅行: XX封    ← ⭐ 新增分类
- 健康: XX封    ← ⭐ 新增分类
- 系统: XX封    ← ⭐ 新增分类
- 广告: XX封    ← ⭐ 新增分类
- 通用: XX封

预期日志:
分类映射: education -> 教育
分类映射: travel -> 旅行
分类映射: system -> 系统
...
```

---

## 📊 测试记录表

### 分类支持测试

| 分类 | 中文 | 英文 | 测试通过 |
|------|------|------|---------|
| 1 | 工作 | work | ☐ |
| 2 | 财务 | finance | ☐ |
| 3 | 社交 | social | ☐ |
| 4 | 购物 | shopping | ☐ |
| 5 | 新闻 | news | ☐ |
| 6 | 教育 ⭐ | education | ☐ |
| 7 | 旅行 ⭐ | travel | ☐ |
| 8 | 健康 ⭐ | health | ☐ |
| 9 | 系统 ⭐ | system | ☐ |
| 10 | 广告 ⭐ | advertising | ☐ |
| 11 | 垃圾 ⭐ | spam | ☐ |
| 12 | 通用 | general | ☐ |

### 综合检索测试

| 测试用例 | 条件数 | 测试通过 |
|---------|--------|---------|
| 昨天小明发的邮件 | 2 | ☐ |
| 近三天的工作邮件 | 2 | ☐ |
| 重要的工作邮件 | 2 | ☐ |
| 本周重要的工作邮件 | 3 | ☐ |
| 昨天张三发的重要工作邮件 | 4 | ☐ |

---

## 🔍 观察要点

### CMD日志中应该看到：

**分类映射**（12种）:
```
分类过滤: 工作 -> work
分类过滤: 教育 -> education      ← ⭐ 新增
分类过滤: 旅行 -> travel         ← ⭐ 新增
分类过滤: 健康 -> health         ← ⭐ 新增
分类过滤: 系统 -> system         ← ⭐ 新增
分类过滤: 广告 -> advertising    ← ⭐ 新增
分类过滤: 垃圾 -> spam           ← ⭐ 新增
```

**多条件组合**:
```
时间过滤: yesterday -> ...
发件人过滤: 小明
分类过滤: 工作 -> work
重要性过滤: >= 3
```

**统计映射**（反向）:
```
分类映射: work -> 工作
分类映射: education -> 教育      ← ⭐ 新增
分类映射: travel -> 旅行         ← ⭐ 新增
```

---

## ✅ 成功标准

### 必须满足

- [ ] 所有12种分类都能正确查询
- [ ] 分类映射日志正确（中文→英文）
- [ ] 多条件组合查询正常工作
- [ ] AI能理解自然语言中的多个条件
- [ ] 查询结果准确（满足所有条件）

### 应该看到

- [ ] 新增6种分类（教育、旅行、健康、系统、广告、垃圾）都能使用
- [ ] 综合查询返回的邮件确实满足所有条件
- [ ] AI回复清晰说明了查询条件和结果
- [ ] 统计功能能显示所有分类的中文名称

---

## 🐛 问题排查

### 如果分类查询返回0封

**检查**:
1. 数据库中是否有该分类的邮件？
2. CMD日志中的映射是否正确？
3. 分类名称是否拼写正确？

**示例调试**:
```python
# 在Python中检查数据库
from models.database import Database
db = Database()
with db.get_connection() as conn:
    cursor = conn.cursor()
    cursor.execute("""
        SELECT category, COUNT(*) 
        FROM emails 
        WHERE user_id = 2 AND deleted = 0
        GROUP BY category
    """)
    for row in cursor.fetchall():
        print(row)
```

### 如果综合查询不工作

**检查**:
1. CMD日志中是否显示了所有条件？
2. AI是否正确识别了所有条件？
3. 条件是否太严格（没有邮件满足）？

---

## 💡 测试技巧

### 1. 从简单到复杂
```
第1步: 测试单条件（工作邮件）
第2步: 测试双条件（昨天的工作邮件）
第3步: 测试多条件（昨天张三发的重要工作邮件）
```

### 2. 使用真实数据
```
先查看: "近三天邮件" （了解有哪些邮件）
再组合: "近三天的工作邮件" （测试分类过滤）
```

### 3. 观察日志
```
每次查询都查看CMD日志，确认：
✅ AI调用的参数是否正确
✅ 映射是否生效
✅ 返回结果数量是否合理
```

---

## 📝 测试报告模板

```
✅ 完成的测试：
- [ ] 12种分类支持 (X/12)
- [ ] 双条件组合 (X/3)
- [ ] 三条件组合 (X/2)
- [ ] 四条件组合 (X/1)
- [ ] 统计功能新分类显示

❌ 发现的问题：
（如果有，请详细描述）

💡 其他发现：
（任何意外行为或改进建议）
```

---

**现在请重启应用并开始测试！** 🚀

重点测试：
1. **新增的6种分类**（教育、旅行、健康、系统、广告、垃圾）
2. **综合检索**（昨天小明发的邮件）
3. **多条件组合**（本周重要的工作邮件）

