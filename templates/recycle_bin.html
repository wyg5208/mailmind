{% extends "base.html" %}

{% block title %}å›æ”¶ç«™ - AIé‚®ä»¶ç®€æŠ¥ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<!-- æ€§èƒ½ä¼˜åŒ–ç»„ä»¶CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/performance/virtual_scroll.css') }}">
<style>
/* å…¨å±æŒ‰é’®æ ·å¼ */
#fullscreenToggleBtn {
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

#fullscreenToggleBtn:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.05);
}

/* å…¨å±æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
.modal-fullscreen .modal-body {
    padding: 2rem;
}

.modal-fullscreen .modal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.modal-fullscreen .modal-footer {
    border-top: 1px solid #dee2e6;
}

/* ç´§å‡‘é‚®ä»¶å¡ç‰‡æ ·å¼ï¼ˆä¸é¦–é¡µä¸€è‡´ï¼‰ */
.email-item-compact {
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.email-item-compact:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.email-header-compact {
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.email-header-compact:hover { background-color: rgba(0,0,0,0.02); }
.expand-icon { transition: transform 0.2s ease; }
.email-item-compact.expanded .expand-icon { transform: rotate(90deg); }
.email-subject-compact { font-weight: 500; font-size: 0.95rem; color: #333; }
.translate-title-btn { opacity: 0.75; transition: opacity 0.2s ease; }
.translate-title-btn:hover { opacity: 1; }
.translated-title { 
    color: #0d6efd !important; 
    font-style: italic; 
    position: relative;
}
.translated-title::after {
    content: " [è¯‘]";
    font-size: 0.7em;
    color: #6c757d;
    font-style: normal;
}

/* åˆ†ç±»æ ‡ç­¾æ ·å¼ä¼˜åŒ– */
.badge.category-badge {
    transition: all 0.2s ease;
    font-weight: 500;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.badge.category-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    filter: brightness(1.1);
}

/* é‡è¦æ€§æ ‡ç­¾å¼ºè°ƒ */
.badge.importance-badge {
    font-weight: 600;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* å›æ”¶ç«™ç‰¹æ®Šæ ·å¼ */
.recycle-bin-header {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.deleted-email-card {
    opacity: 0.85;
    border-left: 4px solid #dc3545 !important;
}

.restore-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.restore-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    color: white;
}

.purge-btn {
    background: linear-gradient(135deg, #dc3545, #c82333);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.purge-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    color: white;
}

/* æ‚¬æµ®é€æ˜æé†’æ ‡ç­¾æ ·å¼ */
.floating-tooltip {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    max-width: 350px;
    background: rgba(13, 110, 253, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    color: white;
    animation: slideInRight 0.3s ease-out;
}

.tooltip-content {
    padding: 16px 20px;
}

.tooltip-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 0.95rem;
}

.tooltip-header .btn-close {
    background: rgba(255,255,255,0.3);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
}

.tooltip-header .btn-close:hover {
    background: rgba(255,255,255,0.5);
}

.tooltip-header .btn-close::before {
    content: 'Ã—';
    color: white;
    font-size: 16px;
    font-weight: bold;
}

.tooltip-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.85rem;
    line-height: 1.4;
}

.tooltip-list li {
    margin-bottom: 8px;
    padding-left: 16px;
    position: relative;
}

.tooltip-list li::before {
    content: 'â€¢';
    position: absolute;
    left: 0;
    color: rgba(255,255,255,0.8);
}

.tooltip-list li:last-child {
    margin-bottom: 0;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* å¸®åŠ©æŒ‰é’®æ ·å¼ */
.help-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1040;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: none;
    color: white;
    font-size: 20px;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    transition: all 0.3s ease;
    cursor: pointer;
}

.help-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,123,255,0.4);
    background: linear-gradient(135deg, #0056b3, #004085);
}

/* å“åº”å¼ä¼˜åŒ– - ç§»åŠ¨ç«¯ */
@media (max-width: 576px) {
    .badge.category-badge {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.35rem !important;
    }
    
    .floating-tooltip {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
    }
    
    .help-btn {
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
        font-size: 18px;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- æ‚¬æµ®é€æ˜æé†’æ ‡ç­¾ -->
<div id="floatingTooltip" class="floating-tooltip" style="display: none;">
    <div class="tooltip-content">
        <div class="tooltip-header">
            <i class="fas fa-info-circle me-2"></i>
            <strong>å›æ”¶ç«™ä½¿ç”¨è¯´æ˜</strong>
            <button class="btn-close" onclick="hideFloatingTooltip()"></button>
        </div>
        <ul class="tooltip-list">
            <li><strong>å·²åˆ é™¤çš„é‚®ä»¶ä»ä¼šé˜»æ­¢ç›¸åŒé‚®ä»¶é‡æ–°å¯¼å…¥</strong> - é˜²æ­¢åƒåœ¾é‚®ä»¶é‡å¤å‡ºç°</li>
            <li><strong>æ¢å¤é‚®ä»¶</strong> - é‚®ä»¶é‡æ–°å‡ºç°åœ¨é‚®ä»¶åˆ—è¡¨ä¸­</li>
            <li><strong>å½»åº•åˆ é™¤</strong> - æ°¸ä¹…åˆ é™¤ä¸”æ— æ³•æ¢å¤ï¼Œç›¸åŒé‚®ä»¶å¯èƒ½é‡æ–°å¯¼å…¥</li>
        </ul>
    </div>
</div>

<!-- é¡¶éƒ¨æ‰¹é‡å±•å¼€/æ”¶èµ·æ§åˆ¶ -->
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <span class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                å…±æ‰¾åˆ° {{ total }} å°å·²åˆ é™¤é‚®ä»¶
            </span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm expand-all-btn" data-scope="all">
                <i class="fas fa-chevron-down"></i> å±•å¼€å…¨éƒ¨
            </button>
            <button class="btn btn-outline-secondary btn-sm collapse-all-btn" data-scope="all" style="display:none;">
                <i class="fas fa-chevron-up"></i> æ”¶èµ·å…¨éƒ¨
            </button>
        </div>
    </div>
</div>

<!-- ç­›é€‰å’Œæœç´¢ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form class="row g-3" method="GET">
                    <div class="col-md-4">
                        <label for="search" class="form-label">æœç´¢é‚®ä»¶</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="æœç´¢ä¸»é¢˜ã€å‘ä»¶äººæˆ–å†…å®¹..." value="{{ search }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="category" class="form-label">åˆ†ç±»</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="important" {{ 'selected' if request.args.get('category') == 'important' }}>é‡è¦é‚®ä»¶</option>
                            <option value="work" {{ 'selected' if request.args.get('category') == 'work' }}>ğŸ’¼ å·¥ä½œé‚®ä»¶</option>
                            <option value="finance" {{ 'selected' if request.args.get('category') == 'finance' }}>ğŸ’° è´¢åŠ¡é‚®ä»¶</option>
                            <option value="social" {{ 'selected' if request.args.get('category') == 'social' }}>ğŸ‘¥ ç¤¾äº¤é‚®ä»¶</option>
                            <option value="shopping" {{ 'selected' if request.args.get('category') == 'shopping' }}>ğŸ›’ è´­ç‰©é‚®ä»¶</option>
                            <option value="news" {{ 'selected' if request.args.get('category') == 'news' }}>ğŸ“° èµ„è®¯é‚®ä»¶</option>
                            <option value="education" {{ 'selected' if request.args.get('category') == 'education' }}>ğŸ“ æ•™è‚²å­¦ä¹ </option>
                            <option value="travel" {{ 'selected' if request.args.get('category') == 'travel' }}>âœˆï¸ æ—…è¡Œå‡ºè¡Œ</option>
                            <option value="health" {{ 'selected' if request.args.get('category') == 'health' }}>ğŸ¥ å¥åº·åŒ»ç–—</option>
                            <option value="system" {{ 'selected' if request.args.get('category') == 'system' }}>ğŸ”” ç³»ç»Ÿé€šçŸ¥</option>
                            <option value="advertising" {{ 'selected' if request.args.get('category') == 'advertising' }}>ğŸ“¢ å¹¿å‘Šé‚®ä»¶</option>
                            <option value="spam" {{ 'selected' if request.args.get('category') == 'spam' }}>ğŸ—‘ï¸ åƒåœ¾é‚®ä»¶</option>
                            <option value="general" {{ 'selected' if request.args.get('category') == 'general' }}>ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="provider" class="form-label">é‚®ä»¶æœåŠ¡å•†</label>
                        <select class="form-select" id="provider" name="provider">
                            <option value="">å…¨éƒ¨æœåŠ¡å•†</option>
                            {% for prov in providers %}
                            <option value="{{ prov }}" {{ 'selected' if provider == prov }}>{{ prov }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="processed" class="form-label">å¤„ç†çŠ¶æ€</label>
                        <select class="form-select" id="processed" name="processed">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="1" {{ 'selected' if processed == '1' }}>å·²å¤„ç†</option>
                            <option value="0" {{ 'selected' if processed == '0' }}>æœªå¤„ç†</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i>ç­›é€‰
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- é‚®ä»¶åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        {% if emails %}
        <div class="emails-container">
            {% for email in emails %}
            <div class="email-item-compact card border-start border-danger border-2 mb-1 deleted-email-card" data-email-id="{{ email.id|default(0) }}">
                <!-- ç´§å‡‘æ ‡é¢˜è¡Œï¼ˆå¯ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰ -->
                <div class="email-header-compact card-body py-2 px-3 cursor-pointer" onclick="toggleEmailExpand(this)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="email-title-section flex-grow-1 me-2" style="min-width: 0;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chevron-right expand-icon me-2 text-muted" style="font-size: 0.7rem; transition: transform 0.2s;"></i>
                                
                                <!-- é‡è¦æ€§æ ‡ç­¾ -->
                                {% if email.importance >= 3 %}
                                <span class="badge bg-danger importance-badge me-2" style="font-size: 0.6rem;">ğŸ”´ é‡è¦</span>
                                {% elif email.importance == 2 %}
                                <span class="badge bg-warning importance-badge me-2" style="font-size: 0.6rem;">ğŸŸ¡ ä¸­ç­‰</span>
                                {% endif %}
                                
                                <!-- åˆ†ç±»æ ‡ç­¾ -->
                                {% if email.category %}
                                    {% set category_config = {
                                        'work': {'icon': 'ğŸ’¼', 'color': 'primary', 'name': 'å·¥ä½œ'},
                                        'finance': {'icon': 'ğŸ’°', 'color': 'success', 'name': 'è´¢åŠ¡'},
                                        'social': {'icon': 'ğŸ‘¥', 'color': 'info', 'name': 'ç¤¾äº¤'},
                                        'shopping': {'icon': 'ğŸ›’', 'color': 'warning', 'name': 'è´­ç‰©'},
                                        'news': {'icon': 'ğŸ“°', 'color': 'secondary', 'name': 'èµ„è®¯'},
                                        'education': {'icon': 'ğŸ“', 'color': 'primary', 'name': 'æ•™è‚²'},
                                        'travel': {'icon': 'âœˆï¸', 'color': 'info', 'name': 'æ—…è¡Œ'},
                                        'health': {'icon': 'ğŸ¥', 'color': 'danger', 'name': 'å¥åº·'},
                                        'system': {'icon': 'ğŸ””', 'color': 'dark', 'name': 'ç³»ç»Ÿ'},
                                        'advertising': {'icon': 'ğŸ“¢', 'color': 'info', 'name': 'å¹¿å‘Š'},
                                        'spam': {'icon': 'ğŸ—‘ï¸', 'color': 'danger', 'name': 'åƒåœ¾'},
                                        'general': {'icon': 'ğŸ“', 'color': 'light text-dark', 'name': 'å…¶ä»–'}
                                    } %}
                                    {% set cat = category_config.get(email.category, category_config['general']) %}
                                    <a href="?category={{ email.category }}" 
                                       class="badge bg-{{ cat.color }} category-badge me-2 text-decoration-none" 
                                       style="font-size: 0.65rem; cursor: pointer;" 
                                       title="åˆ†ç±»: {{ cat.name }}ï¼ˆç‚¹å‡»ç­›é€‰åŒç±»é‚®ä»¶ï¼‰"
                                       onclick="event.stopPropagation();">
                                        {{ cat.icon }}
                                    </a>
                                {% endif %}
                                
                                <!-- é‚®ä»¶ä¸»é¢˜ -->
                                <span class="email-subject-compact text-truncate" data-original-title="{{ email.subject }}">{{ email.subject or 'æ— ä¸»é¢˜' }}</span>
                                
                            </div>
                        </div>
                        
                        <div class="email-meta-compact d-flex align-items-center flex-shrink-0">
                            <small class="text-muted me-2 d-none d-md-inline">{{ email.date[:19].replace('T', ' ') if email.date else '' }}</small>
                            <small class="text-muted me-2 d-none d-sm-inline">{{ email.sender[:20] }}{% if email.sender|length > 20 %}...{% endif %}</small>
                            <span class="badge {{ 'bg-success' if email.processed else 'bg-warning' }} me-2" style="font-size: 0.6rem;">
                                {{ 'å·²å¤„ç†' if email.processed else 'æœªå¤„ç†' }}
                            </span>
                            
                            <!-- ç¿»è¯‘æŒ‰é’® -->
                            <button class="btn btn-outline-info btn-sm translate-title-btn p-1 me-1" 
                                    onclick="event.stopPropagation(); translateTitle(this, '{{ email.subject }}')"
                                    title="ç¿»è¯‘æ ‡é¢˜" data-translated="false" style="font-size: 0.7rem;">
                                <i class="fas fa-language"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- å±•å¼€å†…å®¹åŒºåŸŸ -->
                <div class="email-content-expanded card-body pt-0 pb-2 px-3" style="display: none;">
                    <div class="border-top pt-2">
                        <p class="email-summary text-muted mb-2" style="font-size: 0.9rem;">
                            {% if email.ai_summary %}
                                {{ email.ai_summary }}
                            {% elif email.summary %}
                                {{ email.summary }}
                            {% else %}
                                æš‚æ— æ‘˜è¦
                            {% endif %}
                        </p>
                        <div class="email-meta">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                <span class="sender-display">
                                    {% set sender_parts = email.sender.split('<') if email.sender and '<' in email.sender else [] %}
                                    {% if sender_parts|length == 2 %}
                                        <span class="fw-bold">{{ sender_parts[0].strip().strip('"').strip("'") }}</span>
                                        <span class="text-muted ms-1">&lt;{{ sender_parts[1].rstrip('>') }}&gt;</span>
                                    {% elif email.sender and '@' in email.sender %}
                                        <span class="fw-bold">{{ email.sender.split('@')[0] }}</span>
                                        <span class="text-muted ms-1">&lt;{{ email.sender }}&gt;</span>
                                    {% else %}
                                        <span class="fw-bold">{{ email.sender or 'æœªçŸ¥å‘ä»¶äºº' }}</span>
                                    {% endif %}
                                </span>
                                {% if email.account_email %}
                                <i class="fas fa-at ms-2 me-1"></i>{{ email.account_email }}
                                {% endif %}
                            </small>
                        </div>
                        <div class="mt-2 d-flex gap-2 flex-wrap">
                            <button class="btn restore-btn btn-sm" onclick="restoreEmail({{ email.id }})" 
                                    title="æ¢å¤é‚®ä»¶åˆ°æ­£å¸¸çŠ¶æ€ï¼Œé‡æ–°å‡ºç°åœ¨é‚®ä»¶åˆ—è¡¨ä¸­">
                                <i class="fas fa-undo me-1"></i>æ¢å¤é‚®ä»¶
                            </button>
                            
                            <button class="btn btn-outline-primary btn-sm" data-email-id="{{ email.id|default(0) }}" onclick="viewEmailDetail(this.dataset.emailId)"
                                    title="æŸ¥çœ‹é‚®ä»¶çš„å®Œæ•´å†…å®¹å’Œè¯¦ç»†ä¿¡æ¯">
                                <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            
                            <button class="btn btn-outline-info btn-sm" onclick="translateEmail({{ email.id }})"
                                    title="ç¿»è¯‘é‚®ä»¶å†…å®¹">
                                <i class="fas fa-language me-1"></i>ç¿»è¯‘
                            </button>
                            
                            <button class="btn purge-btn btn-sm" onclick="purgeEmail({{ email.id }})" 
                                    title="æ°¸ä¹…åˆ é™¤é‚®ä»¶ï¼Œæ— æ³•æ¢å¤ã€‚æ³¨æ„ï¼šç›¸åŒé‚®ä»¶å¯èƒ½ä¼šè¢«é‡æ–°å¯¼å…¥">
                                <i class="fas fa-trash me-1"></i>å½»åº•åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- åˆ†é¡µå¯¼èˆª -->
        {% if total_pages > 1 %}
        <nav aria-label="é‚®ä»¶åˆ†é¡µ" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if has_prev %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page - 1 }}&search={{ search }}&category={{ category }}&provider={{ provider }}&processed={{ processed }}">
                        <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                    </a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                    {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ p }}&search={{ search }}&category={{ category }}&provider={{ provider }}&processed={{ processed }}">{{ p }}</a>
                    </li>
                    {% elif p == 4 and page > 6 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% elif p == total_pages - 3 and page < total_pages - 5 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page + 1 }}&search={{ search }}&category={{ category }}&provider={{ provider }}&processed={{ processed }}">
                        ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <!-- ç©ºçŠ¶æ€ -->
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-trash-restore text-muted" style="font-size: 4rem;"></i>
            </div>
            <h4 class="text-muted">å›æ”¶ç«™æ˜¯ç©ºçš„</h4>
            <p class="text-muted">æ²¡æœ‰æ‰¾åˆ°å·²åˆ é™¤çš„é‚®ä»¶</p>
            <a href="{{ url_for('emails') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-1"></i>è¿”å›é‚®ä»¶åˆ—è¡¨
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é‚®ä»¶è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="emailDetailContent">
                <!-- é‚®ä»¶è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailDetailModal" tabindex="-1" aria-labelledby="emailDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="emailDetailModalLabel">
                    <i class="fas fa-envelope-open me-2"></i>é‚®ä»¶è¯¦æƒ…
                </h5>
                <div class="d-flex">
                    <button type="button" class="btn btn-sm btn-outline-light me-2" id="fullscreenToggleBtn" onclick="toggleFullscreen()" title="å…¨å±/é€€å‡ºå…¨å±">
                        <i class="fas fa-expand" id="fullscreenIcon"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
            </div>
            <div class="modal-body" id="emailDetailContent">
                <!-- é‚®ä»¶è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ è½½ -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½é‚®ä»¶è¯¦æƒ…...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å…³é—­
                </button>
                <button type="button" class="btn restore-btn" id="restoreEmailBtn" onclick="restoreCurrentEmail()" style="display: none;">
                    <i class="fas fa-undo me-1"></i>æ¢å¤é‚®ä»¶
                </button>
                <button type="button" class="btn purge-btn" id="purgeEmailBtn" onclick="purgeCurrentEmail()" style="display: none;">
                    <i class="fas fa-trash me-1"></i>å½»åº•åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ‚¬æµ®å¸®åŠ©æŒ‰é’® -->
<button class="help-btn" onclick="showFloatingTooltip()" title="æŸ¥çœ‹å›æ”¶ç«™ä½¿ç”¨è¯´æ˜">
    <i class="fas fa-question"></i>
</button>

{% endblock %}

{% block extra_js %}
<!-- æ€§èƒ½ä¼˜åŒ–ç»„ä»¶JS -->
<script src="{{ url_for('static', filename='js/performance/frontend_cache.js') }}"></script>
<script src="{{ url_for('static', filename='js/performance/smart_pagination.js') }}"></script>
<script src="{{ url_for('static', filename='js/performance/virtual_scroll.js') }}"></script>

<script>
// å±•å¼€/æ”¶èµ·é‚®ä»¶
function toggleEmailExpand(element) {
    const emailItem = element.closest('.email-item-compact');
    const contentArea = emailItem.querySelector('.email-content-expanded');
    const expandIcon = emailItem.querySelector('.expand-icon');
    
    if (!contentArea || !expandIcon) {
        console.error('æ‰¾ä¸åˆ°å±•å¼€å†…å®¹åŒºåŸŸæˆ–å±•å¼€å›¾æ ‡');
        return;
    }
    
    if (emailItem.classList.contains('expanded')) {
        // æ”¶èµ·
        emailItem.classList.remove('expanded');
        contentArea.style.display = 'none';
        expandIcon.style.transform = 'rotate(0deg)';
    } else {
        // å±•å¼€
        emailItem.classList.add('expanded');
        contentArea.style.display = 'block';
        expandIcon.style.transform = 'rotate(90deg)';
    }
}

// å±•å¼€å…¨éƒ¨
document.querySelector('.expand-all-btn').addEventListener('click', function() {
    const emailItems = document.querySelectorAll('.email-item-compact');
    emailItems.forEach(item => {
        const contentArea = item.querySelector('.email-content-expanded');
        const expandIcon = item.querySelector('.expand-icon');
        
        if (contentArea && expandIcon) {
            item.classList.add('expanded');
            contentArea.style.display = 'block';
            expandIcon.style.transform = 'rotate(90deg)';
        }
    });
    
    this.style.display = 'none';
    document.querySelector('.collapse-all-btn').style.display = 'inline-block';
});

// æ”¶èµ·å…¨éƒ¨
document.querySelector('.collapse-all-btn').addEventListener('click', function() {
    const emailItems = document.querySelectorAll('.email-item-compact');
    emailItems.forEach(item => {
        const contentArea = item.querySelector('.email-content-expanded');
        const expandIcon = item.querySelector('.expand-icon');
        
        if (contentArea && expandIcon) {
            item.classList.remove('expanded');
            contentArea.style.display = 'none';
            expandIcon.style.transform = 'rotate(0deg)';
        }
    });
    
    this.style.display = 'none';
    document.querySelector('.expand-all-btn').style.display = 'inline-block';
});

// æ¢å¤é‚®ä»¶
function restoreEmail(emailId) {
    if (!confirm('ç¡®å®šè¦æ¢å¤è¿™å°é‚®ä»¶å—ï¼Ÿ\n\næ¢å¤åï¼š\nâ€¢ é‚®ä»¶å°†é‡æ–°å‡ºç°åœ¨é‚®ä»¶åˆ—è¡¨ä¸­\nâ€¢ å¯ä»¥æ­£å¸¸æŸ¥çœ‹å’Œå¤„ç†\nâ€¢ ä»ç„¶ä¼šé˜»æ­¢ç›¸åŒé‚®ä»¶é‡æ–°å¯¼å…¥')) {
        return;
    }
    
    fetch(`/api/emails/${emailId}/restore`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.status === 401 || response.url.includes('/login')) {
            showAlert('warning', 'è¯·å…ˆç™»å½•');
            setTimeout(() => window.location.href = '/login', 1000);
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (data === null) return;
        
        if (data && data.success) {
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 1000);
        } else if (data) {
            showAlert('danger', data.error || 'æ¢å¤å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('Error restoring email:', error);
        showAlert('danger', 'æ¢å¤å¤±è´¥: ' + error.message);
    });
}

// å½»åº•åˆ é™¤é‚®ä»¶
function purgeEmail(emailId) {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šå½»åº•åˆ é™¤åé‚®ä»¶å°†æ— æ³•æ¢å¤ï¼\n\nå½»åº•åˆ é™¤åï¼š\nâ€¢ é‚®ä»¶å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ— æ³•æ¢å¤\nâ€¢ ç›¸åŒé‚®ä»¶å¯èƒ½ä¼šè¢«é‡æ–°å¯¼å…¥\nâ€¢ å»ºè®®åªå¯¹ä¸¥é‡é—®é¢˜é‚®ä»¶ä½¿ç”¨\n\nç¡®å®šè¦å½»åº•åˆ é™¤è¿™å°é‚®ä»¶å—ï¼Ÿ')) {
        return;
    }
    
    fetch(`/api/emails/${emailId}/purge`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.status === 401 || response.url.includes('/login')) {
            showAlert('warning', 'è¯·å…ˆç™»å½•');
            setTimeout(() => window.location.href = '/login', 1000);
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (data === null) return;
        
        if (data && data.success) {
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 1000);
        } else if (data) {
            showAlert('danger', data.error || 'åˆ é™¤å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('Error purging email:', error);
        showAlert('danger', 'åˆ é™¤å¤±è´¥: ' + error.message);
    });
}

// æŸ¥çœ‹é‚®ä»¶è¯¦æƒ…
function showEmailDetail(emailId) {
    fetch(`/api/emails/${emailId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const email = data.email;
            const modalContent = document.getElementById('emailDetailContent');
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <h6>é‚®ä»¶ä¿¡æ¯</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ä¸»é¢˜ï¼š</strong></td><td>${email.subject}</td></tr>
                            <tr><td><strong>å‘ä»¶äººï¼š</strong></td><td>${email.sender}</td></tr>
                            <tr><td><strong>æ—¥æœŸï¼š</strong></td><td>${email.date}</td></tr>
                            <tr><td><strong>æœåŠ¡å•†ï¼š</strong></td><td>${email.provider || 'æœªçŸ¥'}</td></tr>
                            <tr><td><strong>åˆ†ç±»ï¼š</strong></td><td>${email.category || 'æœªåˆ†ç±»'}</td></tr>
                            <tr><td><strong>çŠ¶æ€ï¼š</strong></td><td>${email.processed ? 'å·²å¤„ç†' : 'æœªå¤„ç†'}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${email.ai_summary ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-primary"><i class="fas fa-robot me-1"></i>AIæ‘˜è¦</h6>
                        <div class="bg-light p-3 rounded">${email.ai_summary}</div>
                    </div>
                </div>
                ` : ''}
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>é‚®ä»¶å†…å®¹</h6>
                        <div class="border p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                            ${email.body_html || email.body || 'æ— å†…å®¹'}
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('emailDetailModal'));
            modal.show();
        } else {
            showAlert('danger', 'è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('Error fetching email detail:', error);
        showAlert('danger', 'è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥');
    });
}

// ç¿»è¯‘é‚®ä»¶æ ‡é¢˜
function translateTitle(button, title) {
    const titleElement = button.parentElement.querySelector('.email-subject-compact');
    
    if (titleElement.classList.contains('translated-title')) {
        // å·²ç¿»è¯‘ï¼Œæ¢å¤åŸæ–‡
        titleElement.textContent = title.length > 50 ? title.substring(0, 50) + '...' : title;
        titleElement.classList.remove('translated-title');
        button.innerHTML = '<i class="fas fa-language" style="font-size: 0.7rem;"></i>';
        button.title = 'ç¿»è¯‘æ ‡é¢˜';
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 0.7rem;"></i>';
    button.disabled = true;
    
    fetch('/api/translate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: title,
            target_lang: 'zh'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const translatedText = data.translated_text;
            titleElement.textContent = translatedText.length > 50 ? translatedText.substring(0, 50) + '...' : translatedText;
            titleElement.classList.add('translated-title');
            titleElement.title = translatedText;
            button.innerHTML = '<i class="fas fa-undo" style="font-size: 0.7rem;"></i>';
            button.title = 'æ˜¾ç¤ºåŸæ–‡';
        } else {
            showAlert('warning', 'ç¿»è¯‘å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        console.error('Translation error:', error);
        showAlert('danger', 'ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
    })
    .finally(() => {
        button.disabled = false;
        if (!button.innerHTML.includes('fa-undo')) {
            button.innerHTML = '<i class="fas fa-language" style="font-size: 0.7rem;"></i>';
        }
    });
}

// ç¿»è¯‘æ•´å°é‚®ä»¶
function translateEmail(emailId) {
    showAlert('info', 'ç¿»è¯‘åŠŸèƒ½å¼€å‘ä¸­...');
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'times-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container');
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = alertHtml;
    container.insertBefore(tempDiv.firstElementChild, container.firstElementChild);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }
    }, 5000);
}

// è‡ªåŠ¨æäº¤æœç´¢è¡¨å•
let searchTimeout;
document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        this.form.submit();
    }, 1000);
});

// è‡ªåŠ¨æäº¤ç­›é€‰è¡¨å•
document.getElementById('category').addEventListener('change', function() {
    this.form.submit();
});

document.getElementById('provider').addEventListener('change', function() {
    this.form.submit();
});

document.getElementById('processed').addEventListener('change', function() {
    this.form.submit();
});

// æ‚¬æµ®æé†’æ§åˆ¶å‡½æ•°
function showFloatingTooltip() {
    const tooltip = document.getElementById('floatingTooltip');
    tooltip.style.display = 'block';
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        hideFloatingTooltip();
    }, 8000);
}

function hideFloatingTooltip() {
    const tooltip = document.getElementById('floatingTooltip');
    tooltip.style.display = 'none';
}

// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºä¸€æ¬¡æé†’ï¼ˆå¯é€‰ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®å›æ”¶ç«™
    const hasVisited = localStorage.getItem('recycle_bin_visited');
    if (!hasVisited) {
        setTimeout(() => {
            showFloatingTooltip();
            localStorage.setItem('recycle_bin_visited', 'true');
        }, 1000);
    }
});

// å…¨å±€å˜é‡
let currentEmailId = null;
let isFullscreen = false;

// æŸ¥çœ‹é‚®ä»¶è¯¦æƒ…
function viewEmailDetail(emailId) {
    currentEmailId = emailId;
    const modal = new bootstrap.Modal(document.getElementById('emailDetailModal'));
    const contentDiv = document.getElementById('emailDetailContent');
    const restoreBtn = document.getElementById('restoreEmailBtn');
    const purgeBtn = document.getElementById('purgeEmailBtn');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½é‚®ä»¶è¯¦æƒ…...</p>
        </div>
    `;
    
    // éšè—æ“ä½œæŒ‰é’®
    restoreBtn.style.display = 'none';
    purgeBtn.style.display = 'none';
    
    modal.show();
    
    // å‘é€AJAXè¯·æ±‚è·å–é‚®ä»¶è¯¦æƒ…
    fetch(`/api/emails/${emailId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(email => {
            // æ˜¾ç¤ºé‚®ä»¶è¯¦æƒ…
            displayEmailDetail(email);
            // æ˜¾ç¤ºå›æ”¶ç«™æ“ä½œæŒ‰é’®
            restoreBtn.style.display = 'inline-block';
            purgeBtn.style.display = 'inline-block';
        })
        .catch(error => {
            console.error('Error fetching email detail:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    è·å–é‚®ä»¶è¯¦æƒ…å¤±è´¥: ${error.message}
                </div>
            `;
        });
}

// æ˜¾ç¤ºé‚®ä»¶è¯¦æƒ…
function displayEmailDetail(email) {
    const contentDiv = document.getElementById('emailDetailContent');
    
    // æ ¼å¼åŒ–æ”¶ä»¶äººåˆ—è¡¨
    const recipients = Array.isArray(email.recipients) ? email.recipients.join(', ') : email.recipients || 'æ— ';
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    const emailDate = new Date(email.date).toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    // é‡è¦æ€§æ ‡ç­¾
    const importanceBadge = email.importance >= 3 ? 
        '<span class="badge bg-danger me-2"><i class="fas fa-exclamation-triangle me-1"></i>é‡è¦</span>' :
        email.importance === 2 ?
        '<span class="badge bg-warning me-2"><i class="fas fa-exclamation-circle me-1"></i>ä¸­ç­‰</span>' : '';
    
    // åˆ†ç±»æ ‡ç­¾é…ç½®
    const categoryConfig = {
        'work': { name: 'å·¥ä½œé‚®ä»¶', color: 'primary' },
        'finance': { name: 'è´¢åŠ¡é‚®ä»¶', color: 'success' },
        'social': { name: 'ç¤¾äº¤é‚®ä»¶', color: 'info' },
        'shopping': { name: 'è´­ç‰©é‚®ä»¶', color: 'warning' },
        'news': { name: 'èµ„è®¯é‚®ä»¶', color: 'secondary' },
        'education': { name: 'æ•™è‚²å­¦ä¹ ', color: 'primary' },
        'travel': { name: 'æ—…è¡Œå‡ºè¡Œ', color: 'info' },
        'health': { name: 'å¥åº·åŒ»ç–—', color: 'danger' },
        'system': { name: 'ç³»ç»Ÿé€šçŸ¥', color: 'dark' },
        'spam': { name: 'åƒåœ¾é‚®ä»¶', color: 'danger' },
        'general': { name: 'å…¶ä»–é‚®ä»¶', color: 'light text-dark' }
    };
    const category = categoryConfig[email.category] || categoryConfig['general'];
    const categoryName = category.name;
    const categoryColor = category.color;
    
    contentDiv.innerHTML = `
        <div class="email-detail">
            <!-- é‚®ä»¶å¤´éƒ¨ä¿¡æ¯ -->
            <div class="email-header-section mb-4">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="email-subject mb-3">
                            ${importanceBadge}
                            <span class="badge bg-danger me-2"><i class="fas fa-trash me-1"></i>å·²åˆ é™¤</span>
                            ${email.subject || 'æ— ä¸»é¢˜'}
                        </h4>
                        <div class="email-meta-info">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <strong class="text-muted">å‘ä»¶äºº:</strong>
                                    <p class="mb-0">${formatSender(email.sender)}</p>
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-muted">æ”¶ä»¶äºº:</strong>
                                    <p class="mb-0">${recipients}</p>
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-muted">æ¥æ”¶æ—¶é—´:</strong>
                                    <p class="mb-0">${emailDate}</p>
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-muted">é‚®ç®±è´¦æˆ·:</strong>
                                    <p class="mb-0">
                                        ${email.account_email || 'æœªçŸ¥'}
                                        <span class="badge bg-primary ms-2">${(email.provider || '').toUpperCase()}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="email-status-badges">
                            <div class="mb-2">
                                <span class="badge bg-${categoryColor}">
                                    <i class="fas fa-tag me-1"></i>${categoryName}
                                </span>
                            </div>
                            <div class="mb-2">
                                ${email.processed ? 
                                    '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>å·²å¤„ç†</span>' :
                                    '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>æœªå¤„ç†</span>'
                                }
                            </div>
                            <div>
                                <small class="text-muted">
                                    <i class="fas fa-fingerprint me-1"></i>
                                    ID: ${email.id}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AIæ‘˜è¦éƒ¨åˆ† -->
            ${email.ai_summary ? `
            <div class="ai-summary-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-robot text-primary me-2"></i>AIæ™ºèƒ½æ‘˜è¦
                </h5>
                <div class="ai-summary-content bg-light p-3 rounded border-start border-primary border-3">
                    <p class="mb-0">${email.ai_summary}</p>
                </div>
            </div>
            ` : ''}
            
            <!-- åŸºç¡€æ‘˜è¦éƒ¨åˆ† -->
            ${email.summary && email.summary !== email.ai_summary ? `
            <div class="basic-summary-section mb-4">
                <h5 class="section-title">
                    <i class="fas fa-file-alt text-secondary me-2"></i>åŸºç¡€æ‘˜è¦
                </h5>
                <div class="basic-summary-content bg-light p-3 rounded">
                    <p class="mb-0">${email.summary}</p>
                </div>
            </div>
            ` : ''}
            
            <!-- é‚®ä»¶æ­£æ–‡ -->
            <div class="email-body-section">
                <h5 class="section-title">
                    <i class="fas fa-file-text text-info me-2"></i>é‚®ä»¶æ­£æ–‡
                    <span class="badge bg-light text-dark ms-2">${email.body ? email.body.length : 0} å­—ç¬¦</span>
                </h5>
                
                <div class="email-body-content bg-white p-3 rounded border">
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${email.body || 'æ— æ­£æ–‡å†…å®¹'}</pre>
                </div>
            </div>
        </div>
    `;
}

// æ ¼å¼åŒ–å‘ä»¶äººæ˜¾ç¤º
function formatSender(sender) {
    if (!sender) return 'æœªçŸ¥å‘ä»¶äºº';
    
    if (sender.includes('<') && sender.includes('>')) {
        const parts = sender.split('<');
        const name = parts[0].trim().replace(/['"]/g, '');
        const email = parts[1].replace('>', '').trim();
        return `<strong>${name}</strong> <span class="text-muted">&lt;${email}&gt;</span>`;
    } else if (sender.includes('@')) {
        const name = sender.split('@')[0];
        return `<strong>${name}</strong> <span class="text-muted">&lt;${sender}&gt;</span>`;
    } else {
        return `<strong>${sender}</strong>`;
    }
}

// å…¨å±åˆ‡æ¢åŠŸèƒ½
function toggleFullscreen() {
    const modal = document.getElementById('emailDetailModal');
    const modalDialog = modal.querySelector('.modal-dialog');
    const fullscreenIcon = document.getElementById('fullscreenIcon');
    const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
    
    if (!isFullscreen) {
        // è¿›å…¥å…¨å±æ¨¡å¼
        modalDialog.classList.remove('modal-xl');
        modalDialog.classList.add('modal-fullscreen');
        fullscreenIcon.classList.remove('fa-expand');
        fullscreenIcon.classList.add('fa-compress');
        fullscreenBtn.title = 'é€€å‡ºå…¨å±';
        isFullscreen = true;
    } else {
        // é€€å‡ºå…¨å±æ¨¡å¼
        modalDialog.classList.remove('modal-fullscreen');
        modalDialog.classList.add('modal-xl');
        fullscreenIcon.classList.remove('fa-compress');
        fullscreenIcon.classList.add('fa-expand');
        fullscreenBtn.title = 'å…¨å±';
        isFullscreen = false;
    }
}

// ä»è¯¦æƒ…æ¨¡æ€æ¡†æ¢å¤å½“å‰é‚®ä»¶
function restoreCurrentEmail() {
    if (!currentEmailId) {
        showAlert('warning', 'æ²¡æœ‰é€‰æ‹©é‚®ä»¶');
        return;
    }
    restoreEmail(currentEmailId);
}

// ä»è¯¦æƒ…æ¨¡æ€æ¡†å½»åº•åˆ é™¤å½“å‰é‚®ä»¶
function purgeCurrentEmail() {
    if (!currentEmailId) {
        showAlert('warning', 'æ²¡æœ‰é€‰æ‹©é‚®ä»¶');
        return;
    }
    purgeEmail(currentEmailId);
}

// ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ï¼Œé‡ç½®å…¨å±çŠ¶æ€
document.getElementById('emailDetailModal').addEventListener('hidden.bs.modal', function () {
    if (isFullscreen) {
        // é‡ç½®å…¨å±çŠ¶æ€
        const modalDialog = this.querySelector('.modal-dialog');
        const fullscreenIcon = document.getElementById('fullscreenIcon');
        const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
        
        modalDialog.classList.remove('modal-fullscreen');
        modalDialog.classList.add('modal-xl');
        fullscreenIcon.classList.remove('fa-compress');
        fullscreenIcon.classList.add('fa-expand');
        fullscreenBtn.title = 'å…¨å±';
        isFullscreen = false;
    }
});
</script>
{% endblock %}
